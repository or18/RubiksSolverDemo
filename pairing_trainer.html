<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="manifest" href="manifest.json">
	<title>Rubik's Cube Free Pair Trainer</title>
	<meta name="description" content="Simple Rubik's Cube Free Pair Trainer.">
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-MXJH30352W"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag() { dataLayer.push(arguments); }
		gtag('js', new Date());
		gtag('config', 'G-MXJH30352W');
	</script>

	<style>
		header {
			padding: 2px;
			text-align: center;
			cursor: pointer;
			background-color: #121212;
		}

		body {
			font-family: Arial, sans-serif;
			margin: 20px;
			padding: 0;
			background-color: #121212;
		}

		h1 {
			font-family: Arial, sans-serif;
			font-size: 24px;
			text-align: center;
			color: #ffffff;
		}

		h2,
		label {
			font-family: Arial, sans-serif;
			font-size: 20px;
			text-align: left;
			color: #ffffff;
		}

		input {
			font-family: Arial, sans-serif;
			width: 100%;
			max-width: 100px;
			height: 40px;
			font-size: 20px;
			padding: 10px;
			margin-bottom: 10px;
			border: 1px solid #41417f;
			border-radius: 4px;
			box-sizing: border-box;
			background-color: #1e1e1e;
			color: #ffffff;
		}

		select {
			font-family: Arial, sans-serif;
			max-width: 200px;
			font-size: 20px;
			padding: 10px;
			margin-bottom: 10px;
			border: 1px solid #ffffff;
			border-radius: 4px;
			box-sizing: border-box;
			background-color: #1e1e1e;
			color: #ffffff;
			cursor: pointer;
		}

		.button {
			font-family: Arial, sans-serif;
			width: 100%;
			font-size: 20px;
			padding: 10px;
			background-color: #56567c;
			color: #ffffff;
			border: none;
			border-radius: 4px;
			cursor: pointer;
		}

		.medium {
			max-width: 100px;
		}

		.small {
			max-width: 40px;
		}

		button:hover {
			background-color: #4a4a6d;
		}

		.button:disabled {
			opacity: 0.65;
			cursor: not-allowed;
		}

		summary {
			box-sizing: border-box;
			display: block;
			font-family: Arial, sans-serif;
			padding: 10px;
			font-size: 20px;
			color: #ffffff;
			width: 100%;
			max-width: 750px;
			cursor: pointer;
		}

		details {
			border: 1px solid #41417f;
			padding: 5px;
			margin: 10px 0;
			width: 100%;
			border-radius: 8px;
		}

		table {
			width: 100%;
			overflow-x: auto;
			display: block;
		}

		th,
		td {
			text-align: left;
			white-space: nowrap;
			color: #ffffff;
			font-family: Arial, sans-serif;
			font-size: 20px;
			min-width: 40px;
			min-height: 40px;
		}

		thead th {
			position: sticky;
			top: 0;
			background: #1e1e1e;
			z-index: 2;
		}

		.checkbox-table {
			width: 100%;
			max-width: 410px;
			margin-top: 10px;
			border-collapse: collapse;
			border: 1px solid #41417f;
		}

		.checkbox-table td {
			border: 1px solid #41417f;
			padding: 10px;
			background-color: #1e1e1e;
			text-align: center;
		}

		.hidden {
			display: none;
		}

		.hidden_small {
			visibility: hidden;
		}

		a,
		pre {
			color: #ffffff;
			font-family: Arial, sans-serif;
			font-size: 20px;
		}

		twisty-player {
			margin: 0;
			width: 100%;
			max-width: 600px;
			margin-bottom: 10px;
            background-color: #000000;
		}

		.custom-checkbox {
			display: none;
		}

		.custom-checkbox+label {
			position: relative;
			padding-left: 33px;
			cursor: pointer;
			font-size: 20px;
			color: #ffffff;
			margin-right: 10x;
		}

		.custom-checkbox+label:before {
			content: '';
			position: absolute;
			left: 0;
			top: 50%;
			transform: translateY(-50%);
			width: 20px;
			height: 20px;
			border: 2px solid #41417f;
			background-color: #1e1e1e;
		}

		.custom-checkbox:checked+label:before {
			background-color: #41417f;
			border-color: #41417f;
		}

		.custom-checkbox:checked+label:after {
			content: '';
			position: absolute;
			left: 9px;
			top: 5px;
			width: 5px;
			height: 10px;
			border: solid white;
			border-width: 0 2px 2px 0;
			transform: rotate(45deg);
		}


		.drawer-overlay {
			position: fixed;
			inset: 0;
			background-color: rgba(0, 0, 0, 0.5);
			z-index: 1000;
		}

		.drawer-overlay.hidden {
			display: none;
		}

		.drawer {
			position: fixed;
			top: 0;
			left: 0;
			height: 100vh;
			height: 100dvh;
			width: 280px;
			background: #1e1e1e;
			border-right: 1px solid #41417f;
			box-shadow: 0 4px 16px #000a;
			padding: 16px;
			transform: translateX(-100%);
			transition: transform 0.2s ease-in-out;
			z-index: 1003;
			overflow: hidden;
			display: flex;
			flex-direction: column;
		}

		.drawer.open {
			transform: translateX(0);
		}

		#hamburger-menu a {
			display: block;
			margin-bottom: 8px;
			white-space: nowrap;
			color: #fff;
			text-decoration: none;
		}

		.drawer-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 8px;
			padding-bottom: 8px;
			margin-bottom: 12px;
			border-bottom: 1px solid #41417f;
		}

		.drawer-title {
			margin: 0;
			font-size: 20px;
			color: #ffffff;
		}

		.drawer-close-btn {
			background: none;
			border: none;
			color: #aaa;
			cursor: pointer;
			font-size: 1.8rem;
			line-height: 1;
			padding: 0 6px;
		}

		.drawer-close-btn:hover {
			color: #fff;
		}

		.drawer-content {
			flex: 1 1 auto;
			min-height: 0;
			overflow-y: auto;
			-webkit-overflow-scrolling: touch;
			padding-right: 4px;
			padding-bottom: 24px;
			padding-bottom: calc(24px + env(safe-area-inset-bottom));
			overscroll-behavior: contain;
			touch-action: pan-y;
		}
	</style>

</head>

<body>
	<header id="header" style="margin-left:48px;margin-top:10px;position:relative;z-index:10;">
		<h1>Rubik's Cube Free Pair Trainer</h1>
	</header>
	<div id="hamburger-menu-container">
		<button id="hamburger-menu-btn" aria-label="Open menu"
			style="background:none;border:none;cursor:pointer;font-size:2.2rem;position:absolute;top:10px;left:10px;z-index:1002;color:#fff;">
			&#9776;
		</button>
		<div id="drawer-overlay" class="drawer-overlay hidden"></div>
		<nav id="hamburger-menu" class="drawer" aria-label="Main navigation">
			<div class="drawer-header">
				<h2 class="drawer-title">Menu</h2>
				<button id="drawer-close-btn" class="drawer-close-btn" aria-label="Close menu">&times;</button>
			</div>
			<div class="drawer-content">
				<a href="https://github.com/or18/RubiksSolverDemo" rel="noopener noreferrer" translate="no">Source</a>
				<a href="index.html">Main Solver</a>
				<a href="2x2x2.html" rel="noopener noreferrer" translate="no">2x2x2 Solver</a>
				<a href="documentation.html" translate="no">Documentation</a>
				<span style="font-weight:bold;margin-top:12px;display:block;color:#fff;">Trainers:</span>
				<a href="cross_trainer.html" rel="noopener noreferrer" translate="no">Cross</a>
				<a href="xcross_trainer.html" rel="noopener noreferrer" translate="no">XCross</a>
                <a href="xxcross_trainer.html" rel="noopener noreferrer" translate="no">XXCross</a>
				<a href="pairing_trainer.html" rel="noopener noreferrer" translate="no">Free Pair</a>
                <a href="xcross_pairing_trainer.html" rel="noopener noreferrer" translate="no">XCross Free Pair</a>
				<a href="pseudo_xcross_trainer.html" rel="noopener noreferrer" translate="no">Pseudo XCross</a>
				<a href="pseudo_pairing_trainer.html" rel="noopener noreferrer" translate="no">Pseudo Free Pair</a>
				<a href="eocross_trainer.html" rel="noopener noreferrer" translate="no">EOCross</a>
				<a href="algTrainer.html" rel="noopener noreferrer" translate="no">Alg Trainer</a>
				<a href="jsonEditor.html" rel="noopener noreferrer" translate="no">JSON Editor</a>
				<span style="font-weight:bold;margin-top:12px;display:block;color:#fff;">External tools:</span>
				<a href="https://trangium.github.io/MovecountCoefficient/" target="_blank" rel="noopener noreferrer"
					translate="no">MCC by trangium</a>
				<a href="https://speedcubedb.com/a/3x3/" target="_blank" rel="noopener noreferrer"
					translate="no">speedcubedb.com</a>
				<a href="https://cstimer.net/" target="_blank" rel="noopener noreferrer" translate="no">cstimer.net</a>
			</div>
		</nav>
	</div>
	<script>
		const hamburgerBtn = document.getElementById('hamburger-menu-btn');
		const drawer = document.getElementById('hamburger-menu');
		const overlay = document.getElementById('drawer-overlay');
		const drawerCloseBtn = document.getElementById('drawer-close-btn');

		function openDrawer() {
			drawer.classList.add('open');
			overlay.classList.remove('hidden');
			document.body.style.overflow = 'hidden';
		}

		function closeDrawer() {
			drawer.classList.remove('open');
			overlay.classList.add('hidden');
			document.body.style.overflow = '';
		}

		hamburgerBtn.addEventListener('click', (e) => {
			e.stopPropagation();
			if (drawer.classList.contains('open')) {
				closeDrawer();
			} else {
				openDrawer();
			}
		});

		overlay.addEventListener('click', closeDrawer);
		if (drawerCloseBtn) drawerCloseBtn.addEventListener('click', closeDrawer);
		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape' && drawer.classList.contains('open')) closeDrawer();
		});
		drawer.addEventListener('click', (e) => {
			const target = e.target;
			if (target.tagName === 'A') {
				closeDrawer();
			}
		});
	</script>
	<a>Warning: This scrambler generates about 700 MB locally on first run; initial scramble generation may take several
		seconds to tens of seconds. </a><br><br>

	<label for="rot">Rotation: </label>
	<select translate="no" id="rot">
		<option translate="no" value="">None</option>
		<option translate="no" value="y">y</option>
		<option translate="no" value="y2">y2</option>
		<option translate="no" value="y'">y'</option>
		<option translate="no" value="z2" selected>z2</option>
		<option translate="no" value="z2 y">z2 y</option>
		<option translate="no" value="z2 y2">z2 y2</option>
		<option translate="no" value="z2 y'">z2 y'</option>
		<option translate="no" value="z'">z'</option>
		<option translate="no" value="z' y">z' y</option>
		<option translate="no" value="z' y2">z' y2</option>
		<option translate="no" value="z' y'">z' y'</option>
		<option translate="no" value="z">z</option>
		<option translate="no" value="z y">z y</option>
		<option translate="no" value="z y2">z y2</option>
		<option translate="no" value="z y'">z y'</option>
		<option translate="no" value="x'">x'</option>
		<option translate="no" value="x' y">x' y</option>
		<option translate="no" value="x' y2">x' y2</option>
		<option translate="no" value="x' y'">x' y'</option>
		<option translate="no" value="x2">x2</option>
		<option translate="no" value="x2 y">x2 y</option>
		<option translate="no" value="x2 y2">x2 y2</option>
		<option translate="no" value="x2 y'">x2 y'</option>
		<option translate="no" value="x">x</option>
		<option translate="no" value="x y">x y</option>
		<option translate="no" value="x y2">x y2</option>
		<option translate="no" value="x y'">x y'</option>
	</select><br>
	<label for="slot">Free Pair: </label>
	<select translate="no" id="slot">
		<option translate="no" value="BL">BL</option>
		<option translate="no" value="BR">BR</option>
		<option translate="no" value="FR">FR</option>
		<option translate="no" value="FL">FL</option>
	</select><br>
	<label for="len">Length: </label>
	<select translate="no" id="len">
		<option translate="no" value="1">1</option>
		<option translate="no" value="2">2</option>
		<option translate="no" value="3">3</option>
		<option translate="no" value="4">4</option>
		<option translate="no" value="5">5</option>
		<option translate="no" value="6">6</option>
		<option translate="no" value="7" selected>7</option>
		<option translate="no" value="8">8</option>
		<option translate="no" value="9">9</option>
	</select><br>
	<button id="back" class="button medium" onclick="back()" disabled>Back</button>
	<button id="next" class="button medium" onclick="genscr()">Next</button><br>
	<h2 id="scr"></h2>
	<div id="show"></div>
	<details id="advancedSettings">
		<summary id="summaryAdvancedSettings">Show Advanced Settings</summary><br>
		        <label for="res">Move Restrict: </label>
        <div translate="no" id="res">

            <table class="checkbox-table">
                <tbody>
                    <tr>
                        <td>
                            <input type="checkbox" id="checkboxU_restrict" class="custom-checkbox restrict" value="U"
                                checked>
                            <label translate="no" for="checkboxU_restrict">U</label>
                        </td>
                        <td>
                            <input type="checkbox" id="checkboxD_restrict" class="custom-checkbox restrict" value="D"
                                checked>
                            <label translate="no" for="checkboxD_restrict">D</label>
                        </td>
                        <td>
                            <input type="checkbox" id="checkboxL_restrict" class="custom-checkbox restrict" value="L"
                                checked>
                            <label translate="no" for="checkboxL_restrict">L</label>
                        </td>
                        <td>
                            <input type="checkbox" id="checkboxR_restrict" class="custom-checkbox restrict" value="R"
                                checked>
                            <label translate="no" for="checkboxR_restrict">R</label>
                        </td>
                        <td>
                            <input type="checkbox" id="checkboxF_restrict" class="custom-checkbox restrict" value="F"
                                checked>
                            <label translate="no" for="checkboxF_restrict">F</label>
                        </td>
                        <td>
                            <input type="checkbox" id="checkboxB_restrict" class="custom-checkbox restrict" value="B"
                                checked>
                            <label translate="no" for="checkboxB_restrict">B</label>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <input type="checkbox" id="checkboxu_restrict" class="custom-checkbox restrict" value="u">
                            <label translate="no" for="checkboxu_restrict">u</label>
                        </td>
                        <td>
                            <input type="checkbox" id="checkboxd_restrict" class="custom-checkbox restrict" value="d">
                            <label translate="no" for="checkboxd_restrict">d</label>
                        </td>
                        <td>
                            <input type="checkbox" id="checkboxl_restrict" class="custom-checkbox restrict" value="l">
                            <label translate="no" for="checkboxl_restrict">l</label>
                        </td>
                        <td>
                            <input type="checkbox" id="checkboxr_restrict" class="custom-checkbox restrict" value="r">
                            <label translate="no" for="checkboxr_restrict">r</label>
                        </td>
                        <td>
                            <input type="checkbox" id="checkboxf_restrict" class="custom-checkbox restrict" value="f">
                            <label translate="no" for="checkboxf_restrict">f</label>
                        </td>
                        <td>
                            <input type="checkbox" id="checkboxb_restrict" class="custom-checkbox restrict" value="b">
                            <label translate="no" for="checkboxb_restrict">b</label>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <input type="checkbox" id="checkboxM_restrict" class="custom-checkbox restrict" value="M">
                            <label translate="no" for="checkboxM_restrict">M</label>
                        </td>
                        <td>
                            <input type="checkbox" id="checkboxE_restrict" class="custom-checkbox restrict" value="E">
                            <label translate="no" for="checkboxE_restrict">E</label>
                        </td>
                        <td>
                            <input type="checkbox" id="checkboxS_restrict" class="custom-checkbox restrict" value="S">
                            <label translate="no" for="checkboxS_restrict">S</label>
                        </td>
                        <td>
                            <input type="checkbox" id="checkboxx_restrict" class="custom-checkbox restrict" value="x">
                            <label translate="no" for="checkboxx_restrict">x</label>
                        </td>
                        <td>
                            <input type="checkbox" id="checkboxy_restrict" class="custom-checkbox restrict" value="y">
                            <label translate="no" for="checkboxy_restrict">y</label>
                        </td>
                        <td>
                            <input type="checkbox" id="checkboxz_restrict" class="custom-checkbox restrict" value="z">
                            <label translate="no" for="checkboxz_restrict">z</label>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div><br>
		<label for="premove">Pre Move: </label>
		<input type="text" id="premove"><br>
		<input type="checkbox" id="ignorePremoveCenter" class="custom-checkbox">
		<label for="ignorePremoveCenter">Ignore Pre-move Center</label>
	</details>
	<br>
	<button id="solveButton" class="button medium" onclick="startWorker()">Solve</button><br>
	<label for="countLine">Number of solutions: </label>
	<input type="text" id="countLine" value="0" readonly><br>
    <label for="currentDepth">Current Depth: </label>
    <input type="text" id="currentDepth" value="-1" readonly>
	<div id="result"></div>

	<script type="module">
		let twistyPromise = null;
		function ensureTwisty() {
			if (!twistyPromise) {
				twistyPromise = import('https://cdn.cubing.net/v0/js/cubing/twisty')
					.then(mod => {
						console.log('Twisty module loaded exports:', Object.keys(mod || {}));
						const Ctor = mod.TwistyPlayer || mod.default || (mod.default && mod.default.TwistyPlayer) || window.TwistyPlayer || null;
						console.log('Resolved TwistyPlayer constructor:', Ctor);
						window.__TwistyModule = mod;
						window.__TwistyPlayerCtor = Ctor;
						return mod;
					})
					.catch(err => {
						console.error('Twisty import failed:', err);
						window.__TwistyLoadError = err;
						throw err;
					});
			}
			return twistyPromise;
		}
		async function createPlayerLazy(setup, alg) {
			const mod = await ensureTwisty();
			const Ctor = mod.TwistyPlayer || mod.default || (mod.default && mod.default.TwistyPlayer) || window.__TwistyPlayerCtor || window.TwistyPlayer;
			if (!Ctor) throw new Error('TwistyPlayer constructor not found in module');
			return new Ctor({ puzzle: '3x3x3', experimentalSetupAlg: setup, alg, background: 'none' });
		}
		window.createPlayerLazy = createPlayerLazy;
		function createPlayer(setup, alg) {
			if (window.__TwistyLoadError) throw window.__TwistyLoadError;
			const Ctor = window.__TwistyPlayerCtor || window.TwistyPlayer;
			if (!Ctor) {
				ensureTwisty().catch(e => console.error('ensureTwisty error:', e));
				throw new Error('TwistyPlayer not available');
			}
			return new Ctor({ puzzle: '3x3x3', experimentalSetupAlg: setup, alg, background: 'none' });
		}
		window.createPlayer = createPlayer;
		window.ensureTwisty = ensureTwisty;
		try { ensureTwisty().catch(() => { }); } catch (e) { }
	</script>

	<script>
		function loadScriptAsync(src) {
			return new Promise((resolve, reject) => {
				if (document.querySelector('script[src="' + src + '"]')) return resolve();
				const s = document.createElement('script');
				s.src = src;
				s.async = true;
				s.onload = () => resolve();
				s.onerror = (e) => reject(new Error('Failed to load ' + src));
				document.head.appendChild(s);
			});
		}
		window.loadMin2phase = function () {
			return window.__min2phaseLoading || (window.__min2phaseLoading = loadScriptAsync('src/min2phase.js/min2phase.js').then(() => window.min2phase));
		};
		window.loadFunctionsJs = function () {
			if (window.__functionsLoading) return window.__functionsLoading;
			window.__functionsLoading = new Promise((resolve, reject) => {
				window.Module = {
					onRuntimeInitialized: () => resolve(window.Module)
				};
				loadScriptAsync('src/functions/functions.js').catch(err => {
					window.__functionsLoading = null;
					reject(err);
				});
			});
			return window.__functionsLoading;
		};
	</script>

	<script>
		let reverse;
		let convert;
		let generateTwoPhaseInput;
		let convertMask;
		let get_center;
		let isFunctionsReady = false;
		let scr_old = null;

		async function InitializeFunctions() {
			const Module = await window.loadFunctionsJs();
			reverse = function (scr) {
				const scr_fixed = scr_fix2(scr);
				if (scr_fixed === "") {
					return;
				}
				const lines = scr_fixed.split('\n');
				const processedLines = [];
				for (let i = lines.length - 1; i >= 0; i--) {
					const line = lines[i];
					const [alg, comment] = line.split('//');
					const alg_revresed = Module.scr_reverse(alg.trim());
					if (comment) {
						processedLines.push(`${alg_revresed} // ${comment.trim()}`);
					} else {
						processedLines.push(alg_revresed);
					}
				}
				const result = processedLines.join('\n');
				return result.trim() + "\n";
			};
			convert = function (scramble) {
				const result = Module.scr_converter(scramble);
				const resultArray = result.split(',');
				return resultArray.map(part => part.trim());
			};
			generateTwoPhaseInput = function (scramble) {
				const result = Module.ScrambleToState(scramble);
				return result;
			};
			convertMask = function (center_input, edge_input, corner_input, rotation_alg) {
				const result = Module.convertMask(center_input, edge_input, corner_input, rotation_alg);
				return result;
			};
			get_center = function (pm) {
				const result = Module.get_center(pm);
				return result;
			};
			isFunctionsReady = true;
		}

		if ('requestIdleCallback' in window) {
			requestIdleCallback(() => { InitializeFunctions(); }, { timeout: 2000 });
		} else {
			setTimeout(() => { InitializeFunctions(); }, 2000);
		}

		let worker;
		let worker2;
		let messageCount = 0;
		let mask = {
			orbits: {
				EDGES: {
					pieces: [
						{ facelets: ["regular", "regular"] },
						{ facelets: ["regular", "regular"] },
						{ facelets: ["regular", "regular"] },
						{ facelets: ["regular", "regular"] },
						{ facelets: ["regular", "regular"] },
						{ facelets: ["regular", "regular"] },
						{ facelets: ["regular", "regular"] },
						{ facelets: ["regular", "regular"] },
						{ facelets: ["regular", "regular"] },
						{ facelets: ["regular", "regular"] },
						{ facelets: ["regular", "regular"] },
						{ facelets: ["regular", "regular"] },
					],
				},
				CORNERS: {
					pieces: [
						{ facelets: ["regular", "regular", "regular"] },
						{ facelets: ["regular", "regular", "regular"] },
						{ facelets: ["regular", "regular", "regular"] },
						{ facelets: ["regular", "regular", "regular"] },
						{ facelets: ["regular", "regular", "regular"] },
						{ facelets: ["regular", "regular", "regular"] },
						{ facelets: ["regular", "regular", "regular"] },
						{ facelets: ["regular", "regular", "regular"] },
					],
				},
				CENTERS: {
					pieces: [
						{ facelets: ["regular"] },
						{ facelets: ["regular"] },
						{ facelets: ["regular"] },
						{ facelets: ["regular"] },
						{ facelets: ["regular"] },
						{ facelets: ["regular"] },
					],
				},
			},
		};

		const slotToEMask = {
			'BL': '--IIII',
			'BR': '-I-III',
			'FR': '-II-II',
			'FL': '-III-I'
		};

		const slotToCMask = {
			'BL': '-IIII',
			'BR': 'I-III',
			'FR': 'II-II',
			'FL': 'III-I'
		};

		function getMaskInputs() {
			const slot = document.getElementById("slot").value;
			const maskInputCenter = "-";
			const maskInputEdges = slotToEMask[slot];
			const maskInputCorners = slotToCMask[slot];
			return { maskInputCenter, maskInputEdges, maskInputCorners };
		}

		function mapFacelet(char) {
			switch (char) {
				case '-':
					return 'regular';
				case 'D':
					return 'dim';
				case 'I':
					return {mask: 'ignored', hintMask: 'invisible'};
				case '?':
					return 'oriented';
			}
		}

		function setMask(inputString) {
			const edgesString = inputString.slice(0, 24);
			const cornersString = inputString.slice(24, 48);
			const centersString = inputString.slice(48, 54);
			const edges = [];
			for (let i = 0; i < edgesString.length; i += 2) {
				edges.push({ facelets: [mapFacelet(edgesString[i]), mapFacelet(edgesString[i + 1])] });
			}
			const corners = [];
			for (let i = 0; i < cornersString.length; i += 3) {
				corners.push({ facelets: [mapFacelet(cornersString[i]), mapFacelet(cornersString[i + 1]), mapFacelet(cornersString[i + 2])] });
			}
			const centers = [];
			for (let i = 0; i < centersString.length; i++) {
				centers.push({ facelets: [mapFacelet(centersString[i])] });
			}
			mask = {
				orbits: {
					EDGES: {
						pieces: edges,
					},
					CORNERS: {
						pieces: corners,
					},
					CENTERS: {
						pieces: centers,
					},
				},
			};
		}

		function scr_fix(scr) {
			const fixed_scr = scr_fix2(scr);
			const output = fixed_scr.split('\n')
				.map(line => line.split('//')[0].trim())
				.filter(line => line.length > 0)
				.join('\n');
			return output;
		}

		function scr_fix2(scr) {
			const outputString = scr.split('\n').map(line => {
				const commentIndex = line.indexOf('//');
				if (commentIndex !== -1) {
					const beforeComment = insertSpaces(line.slice(0, commentIndex));
					const comment = line.slice(commentIndex);
					return beforeComment + ' ' + comment.trim();
				} else {
					return insertSpaces(line);
				}
			}).join('\n');
			return outputString;
		}

		function insertSpaces(input) {
			const keys = ["U", "U2", "U2'", "U'", "D", "D2", "D2'", "D'", "L", "L2", "L2'", "L'", "R", "R2", "R2'", "R'", "F", "F2", "F2'", "F'", "B", "B2", "B2'", "B'", "u", "u2", "u2'", "u'", "d", "d2", "d2'", "d'", "l", "l2", "l2'", "l'", "r", "r2", "r2'", "r'", "f", "f2", "f2'", "f'", "b", "b2", "b2'", "b'", "Uw", "Uw2", "Uw2'", "Uw'", "Dw", "Dw2", "Dw2'", "Dw'", "Lw", "Lw2", "Lw2'", "Lw'", "Rw", "Rw2", "Rw2'", "Rw'", "Fw", "Fw2", "Fw2'", "Fw'", "Bw", "Bw2", "Bw2'", "Bw'", "M", "M2", "M2'", "M'", "S", "S2", "S2'", "S'", "E", "E2", "E2'", "E'", "x", "x2", "x2'", "x'", "y", "y2", "y2'", "y'", "z", "z2", "z2'", "z'"];
			const regex = new RegExp(`(${keys.join('|')})`, 'g');
			return input.replace(regex, ' $1').trim()
				.replace(/\s+/g, ' ');
		}

		function replaceCharacters(input) {
			return input
				.replace(/'/g, '-')
				.replace(/\n/g, '%0A')
				.replace(/\//g, '%2F')
				.replace(/ /g, '_');
		}

		function splitAtLastScramble(input) {
			const scrambleRegex = /\/\/\s*setup/g;
			const index = input.search(scrambleRegex);
			if (index !== -1) {
				const scrambleLineEnd = input.indexOf('\n', index);
				const scrambleLine = input.slice(index, scrambleLineEnd !== -1 ? scrambleLineEnd : undefined).trim();
				const aboveScramble = input.slice(0, scrambleLineEnd !== -1 ? scrambleLineEnd : input.length).trim();
				const belowScramble = input.slice(index + scrambleLine.length).trim();
				return { aboveScramble, belowScramble };
			} else {
				return { aboveScramble: input.trim(), belowScramble: '' };
			}
		}

		function getLink(scr) {
			const fixed_scr = scr_fix2(scr);
			const { aboveScramble, belowScramble } = splitAtLastScramble(fixed_scr);
			const transformedAbove = replaceCharacters(aboveScramble);
			const transformedBelow = replaceCharacters(belowScramble);
			const URL1 = "https://alg.cubing.net/?setup=" + transformedAbove + "&alg=" + transformedBelow + "%0A&puzzle=3x3x3";
			const URL2 = "https://cubedb.net/?puzzle=3x3&scramble=" + transformedAbove + "&alg=" + transformedBelow + "%0A";
			return { URL1, URL2 };
		}

		function getRestrictString() {
            const restrictFieldset = document.getElementById('res');
			const basicMoves = ['U', 'D', 'L', 'R', 'F', 'B'];
			let restString = "U_U2_U-_D_D2_D-_L_L2_L-_R_R2_R-_F_F2_F-_B_B2_B-";
			const resChecked = restrictFieldset.querySelectorAll('input[type="checkbox"]:checked');
			const activeMoves = new Set(basicMoves);
			resChecked.forEach(cb => activeMoves.add(cb.value));
			const resString = Array.from(activeMoves).join('');
			resChecked.forEach(cb => {
				const move = cb.value;
				if (!basicMoves.includes(move)) {
					restString += `_${move}_${move}2_${move}-`;
				}
			});
			return [resString, restString];
		}

		function getMoveCountString() {
			const restrictFieldset = document.getElementById('res')
			const basicMoves = ['U', 'D', 'L', 'R', 'F', 'B'];
			let mcString = '';
			const resChecked = Array.from(restrictFieldset.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
			basicMoves.forEach(move => {
				if (!resChecked.includes(move)) {
					mcString += `${move}:0_${move}2:0_${move}-:0_`;
				}
			});
			return mcString;
		}

        function getMavString() {
            const restrictFieldset = document.getElementById('res');
            const basicMoves = ['U', 'D', 'L', 'R', 'F', 'B'];
			const AXIS_Y = ['U', 'D', 'E', 'u', 'd', 'y'];
            const AXIS_X = ['L', 'R', 'M', 'l', 'r', 'x'];
            const AXIS_Z = ['F', 'B', 'S', 'f', 'b', 'z'];
            const activeMoves = new Set(basicMoves);
            const resChecked = restrictFieldset.querySelectorAll('input[type="checkbox"]:checked');
            resChecked.forEach(cb => activeMoves.add(cb.value));
            const changes = [];
            const rotations = ['x', 'y', 'z'];

			const getAxis = (move) => {
                if (AXIS_X.includes(move)) return 'x';
                if (AXIS_Y.includes(move)) return 'y';
                if (AXIS_Z.includes(move)) return 'z';
                return null;
            };

            rotations.forEach(rotMove => {
                if (!activeMoves.has(rotMove)) return;
				const rotAxis = getAxis(rotMove);

                activeMoves.forEach(move => {
                    if (move == rotMove) return;
                    if (rotations.includes(move)) return;
                    changes.push(`${move}~${rotMove}|${move}2~${rotMove}|${move}-~${rotMove}`);
                    changes.push(`${move}~${rotMove}2|${move}2~${rotMove}2|${move}-~${rotMove}2`);
                    changes.push(`${move}~${rotMove}-|${move}2~${rotMove}-|${move}-~${rotMove}-`);

					const moveAxis = getAxis(move);
                    const isSameAxis = (rotAxis && moveAxis && rotAxis === moveAxis);
					if (!isSameAxis) return;
                    changes.push(`${rotMove}~${move}|${rotMove}2~${move}|${rotMove}-~${move}`);
                    changes.push(`${rotMove}~${move}2|${rotMove}2~${move}2|${rotMove}-~${move}2`);
                    changes.push(`${rotMove}~${move}-|${rotMove}2~${move}-|${rotMove}-~${move}-`);
                });
            });
            return changes.join('|');
        }

		function startWorker() {
			try {
				if (worker) {
					worker.terminate();
					worker = null;
					const element = document.getElementById('result');
					const content = document.createElement('a');
					content.innerHTML = "Search terminated.<br>";
					element.appendChild(content);
                    document.getElementById("solveButton").textContent = "Start";
					return;
				}

				if (!isFunctionsReady) {
					alert("The module is still initializing. Please try again in a moment.");
                    document.getElementById("solveButton").textContent = "Start";
					return;
				}
				if (typeof convert !== "function" || typeof generateTwoPhaseInput !== "function" || typeof convertMask !== "function") {
					alert("Error: The required function is not initialized. Please reload the page manually.");
					const element = document.getElementById('result');
					const content = document.createElement('a');
					content.innerHTML = "Error: Search terminated due an error.<br>";
					element.appendChild(content);
                    document.getElementById("solveButton").textContent = "Start";
					return;
				}
				document.getElementById("countLine").value = 0;
				document.getElementById("result").innerHTML = "";
				messageCount = 0;
				const scr = scr_fix(document.getElementById("scr").innerHTML);
				const premove = scr_fix(document.getElementById('premove').value);
				const slot = document.getElementById("slot").value;
				const len = "20";
				const num = "100";
				const center_offset_from_premove = get_center(premove);
				const center_offset_default = 'EMPTY_EMPTY|EMPTY_y|EMPTY_y2|EMPTY_y-';
				let center_offset;
				if (document.getElementById('ignorePremoveCenter').checked) {
					center_offset = center_offset_default;
				} else {
					center_offset = center_offset_from_premove.startsWith('EMPTY') ? center_offset_default : center_offset_from_premove + '|' + center_offset_default;
				}
				const [resID, restrict] = getRestrictString();
				const ma = getMavString();
				const mcString = getMoveCountString();
                document.getElementById("solveButton").textContent = "End";
				const convertResult = convert(scr);
				const result_moves = convertResult[0];
				const result_rotation = convertResult[1];
				const mask_input = getMaskInputs();
				const convertedMask = convertMask(mask_input.maskInputCenter, mask_input.maskInputEdges, mask_input.maskInputCorners, result_rotation);
				setMask(convertedMask);
				const args = { scr: result_moves, rot: "", slot: "", pslot: slot, num: parseInt(num, 10), len: parseInt(len, 10), move_restrict: restrict, post_alg: premove, center_offset: center_offset, max_rot_count: parseInt('2', 10), ma2: ma, mcString: mcString };
				worker = new Worker('src/F2L_PairingSolver/worker_pairing.js');
				worker.postMessage(args);
				if (worker) {
					worker.onmessage = function (event) {
						appendSol(scr, event.data, premove, center_offset, resID, restrict, ma, mcString);
					};
				}
			} catch (e) {
				console.log(e.message);
				if (worker) {
					worker.terminate();
				}
				worker = null;
				const element = document.getElementById('result');
				const content = document.createElement('a');
				content.innerHTML = "Error: Search terminated due an error.<br>";
				element.appendChild(content);
                document.getElementById("solveButton").textContent = "Start";
				return;
			}
		}

		function appendSol(scr, sol, pm, center_offset, resID, restrict, ma, mcString) {
			const regex = /^depth\s*=\s*(\d+)/;
			const match = sol.trim().match(regex);
			const element = document.getElementById('result');
			if (sol == "Search finished." || sol == "Already solved." || sol == "Error") {
				if (worker) {
					worker.terminate();
				}
				worker = null;
				const element = document.getElementById('result');
				const content = document.createElement('a');
				if (sol == "Error") {
					content.innerHTML = "Error: Search terminated due to an error.<br>";
				} else if (sol === "Already solved.") {
					content.innerHTML = "Already solved.<br>";
				} else if (sol === "Search finished.") {
					content.innerHTML = "Search finished.<br>";
				} else {
					content.innerHTML = "Unsolvable.<br>";
				}
				element.appendChild(content);
                document.getElementById("solveButton").textContent = "Start";
				return;
			} else if (match && match[1]) {
                const depthNumber = match[1];
                document.getElementById('currentDepth').value = depthNumber;
				return;
			} else {
				messageCount++;
				const details = document.createElement('details');
				const summary = document.createElement('summary');
				summary.textContent = messageCount + ": " + sol;
				summary.setAttribute('translate', 'no');
				details.appendChild(summary);
				try {
					const sim = createPlayer(scr, sol);
					sim.experimentalStickeringMaskOrbits = mask;
					details.appendChild(sim);
				} catch (e) {
					if (messageCount === 1) {
						const lineBreak = document.createElement('br');
						details.appendChild(lineBreak);
						const content = document.createElement('a');
						content.innerHTML = "Warning: Failed to create TwistyPlayer.<br>";
						details.appendChild(content);
					}
				}
				const gap = document.createElement('div');
				gap.style.height = '12px';
				details.appendChild(gap);
				const { URL1: link1, URL2: link2 } = getLink(scr + "// setup\n" + sol);
				var link_element1 = document.createElement('a');
				link_element1.href = link1;
				link_element1.target = '_blank';
				link_element1.rel = 'noopener noreferrer';
				link_element1.textContent = 'alg.cubing.net';
				link_element1.setAttribute('translate', 'no');
				details.appendChild(link_element1);
				var spaceElement = document.createElement('a');
				spaceElement.innerHTML = "&nbsp;";
				details.appendChild(spaceElement);
				var link_element2 = document.createElement('a');
				link_element2.href = link2;
				link_element2.target = '_blank';
				link_element2.rel = 'noopener noreferrer';
				link_element2.textContent = 'cubedb.net';
				link_element2.setAttribute('translate', 'no');
				details.appendChild(link_element2);
				var spaceElement2 = document.createElement('a');
				spaceElement2.innerHTML = "&nbsp;";
				details.appendChild(spaceElement2);
				const currentUrl = new URL("index.html", window.location.href);
				currentUrl.searchParams.set('solver', `F2L_pair`);
				currentUrl.searchParams.set('scramble', (scr + " // setup\n").replace(/ /g, '_').replace(/'/g, '-'));
				if (premove !== "") {
					currentUrl.searchParams.set('premove', pm.replace(/ /g, '_').replace(/'/g, '-'));
				}
				currentUrl.searchParams.set('rc', '2');
				if (resID != 'UDLRFB') {
					currentUrl.searchParams.set('res', resID);
				}
				if (restrict != 'U_U2_U-_D_D2_D-_L_L2_L-_R_R2_R-_F_F2_F-_B_B2_B-') {
					currentUrl.searchParams.set('rest', restrict);
				}
				if (mcString) {
					currentUrl.searchParams.set('mcv', mcString);
				}
				if (ma) {
					currentUrl.searchParams.set('mav', ma);
				}
				if (center_offset !== "EMPTY_EMPTY") {
					currentUrl.searchParams.set('crest', center_offset);
				}
				const slot = document.getElementById("slot").value;
				currentUrl.searchParams.set('aslot', `${slot}`);
				currentUrl.searchParams.set('index', `${messageCount}`);
				currentUrl.searchParams.set('sol', sol.replace(/ /g, '_').replace(/'/g, '-'));
				var link_element3 = document.createElement('a');
				link_element3.href = currentUrl;
				link_element3.target = '_blank';
				link_element3.rel = 'noopener noreferrer';
				link_element3.textContent = 'or18.github.io';
				link_element3.setAttribute('translate', 'no');
				details.appendChild(link_element3);
				element.appendChild(details);
				document.getElementById("countLine").value = messageCount;
			}
		}

		function generateTwoPhaseInputWrapper(scr) {
			if (!isFunctionsReady) {
				alert("The module is still initializing. Please try again in a moment.");
				return;
			}
			if (typeof generateTwoPhaseInput !== "function") {
				alert("Error: The required function is not initialized. Please reload the page manually.");
				return;
			} else {
				return generateTwoPhaseInput(scr);
			}
		}

		async function back() {
			let scramble = scr_old;
			if (!scr_old) {
				return;
			}
			scr_old = null;
			document.getElementById('back').disabled = true;
			const show = document.getElementById('show');
			document.getElementById('scr').innerHTML = scramble;
			try {
				show.innerHTML = '';
				const sim = createPlayer(scramble, '');
				sim.experimentalStickeringMaskOrbits = mask;
				sim.controlPanel = "none";
				show.appendChild(sim);
				return;
			} catch (syncErr) {
				console.warn('save: sync createPlayer failed, falling back to async', syncErr);
			}
			const placeholder = document.createElement('div');
			placeholder.className = 'twisty-placeholder';
			placeholder.textContent = 'Loading preview...';
			show.appendChild(placeholder);
			try {
				const real = await createPlayerLazy(scramble, '');
				real.experimentalStickeringMaskOrbits = mask;
				real.controlPanel = "none";
				placeholder.replaceWith(real);
			} catch (asyncErr) {
				console.error('save: async createPlayer failed', asyncErr);
				placeholder.textContent = 'Warning: Failed to create TwistyPlayer.';
			}
		}

		const slotToRot = {
			'BL': "",
			'BR': "y",
			'FR': "y2",
			'FL': "y'"
		};

		async function genscr() {
			if (!isFunctionsReady) {
				alert("The module is still initializing. Please try again in a moment.");
				return;
			}
			if (typeof reverse !== "function" || typeof convert !== "function" || typeof convertMask !== "function" || typeof generateTwoPhaseInput !== "function") {
				alert("Error: The required function is not initialized. Please reload the page manually.");
				return "";
			}
			if (typeof min2phase === 'undefined' || typeof min2phase.randomCube !== 'function') {
				try {
					await window.loadMin2phase();
					console.log('min2phase loaded');
				} catch (e) {
					console.error('Failed to load min2phase:', e);
					alert('Failed to load solver module. Please check network or try again later.');
					return;
				}
			}
			if (typeof min2phase === 'undefined' || typeof min2phase.randomCube !== 'function') {
				console.error('genscr: min2phase still unavailable after load');
				alert('Solver module not available.');
				return;
			}
			const sol_len = document.getElementById("len").value;
			const rot = document.getElementById("rot").value;
			const slot = document.getElementById("slot").value;
			const mask_input = getMaskInputs();
			const convertedMask = convertMask(mask_input.maskInputCenter, mask_input.maskInputEdges, mask_input.maskInputCorners, rot);
			setMask(convertedMask);
			let cube;
			let solution;
			try {
				cube = min2phase.randomCube();
				solution = min2phase.solve(cube);
			} catch (e) {
				console.error('genscr error:', e);
				alert('Failed to generate scramble: see console for details.');
				return;
			}
			if (!worker2) {
				worker2 = new Worker('src/pairingTrainer/worker.js');
			}
			var args = { scr: solution, len: sol_len };
			const show = document.getElementById('show');
			worker2.onmessage = async function (event) {
				try {
					const ret = (event.data).split(",");
					var scramble = min2phase.solve(generateTwoPhaseInputWrapper(convert(ret[2] + reverse(ret[3]) + reverse(ret[0] + reverse(ret[1])) + slotToRot[slot])[0]));
					scramble = scr_fix(rot + scramble);
					const prev = document.getElementById('scr').innerHTML;
					if (prev && prev.trim() !== "") {
						scr_old = prev;
						document.getElementById('back').disabled = false;
					} else {
						scr_old = null;
					}
					document.getElementById('scr').innerHTML = scramble;
					try {
						show.innerHTML = '';
						const sim = createPlayer(scramble, '');
						sim.experimentalStickeringMaskOrbits = mask;
						sim.controlPanel = "none";
						show.appendChild(sim);
						return;
					} catch (syncErr) {
						console.warn('save: sync createPlayer failed, falling back to async', syncErr);
					}
					const placeholder = document.createElement('div');
					placeholder.className = 'twisty-placeholder';
					placeholder.textContent = 'Loading preview...';
					show.appendChild(placeholder);
					try {
						const real = await createPlayerLazy(scramble, '');
						real.experimentalStickeringMaskOrbits = mask;
						real.controlPanel = "none";
						placeholder.replaceWith(real);
					} catch (asyncErr) {
						console.error('save: async createPlayer failed', asyncErr);
						placeholder.textContent = 'Warning: Failed to create TwistyPlayer.';
					}
				} catch (e) {
					console.error('worker2.onmessage error:', e);
				}
			};
			worker2.postMessage(args);
		}

		
        const details_advanced_settings = document.getElementById("advancedSettings");
        const summary_advanced_settings = document.getElementById("summaryAdvancedSettings");
		details_advanced_settings.addEventListener('toggle', () => {
            if (details_advanced_settings.open) {
                summary_advanced_settings.textContent = "Hide Advanced Settings";
            } else {
                summary_advanced_settings.textContent = "Show Advanced Settings";
            }
        });

	</script>
	<script src="sw-register.js" defer></script>

</body>

</html>